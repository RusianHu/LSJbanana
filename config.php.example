<?php

// 配置文件
// 存储敏感信息和全局配置

// ============================================================
// 时区配置
// ============================================================

// 设置默认时区 (中国标准时间)
// 完整时区列表: https://www.php.net/manual/zh/timezones.php
date_default_timezone_set('Asia/Shanghai');

// ============================================================
// 用户系统与支付配置
// ============================================================

// 数据库配置 (SQLite)
$databaseConfig = [
    'driver' => 'sqlite',
    'path' => __DIR__ . '/database/lsjbanana.db',  // SQLite 数据库文件路径
];

// 支付配置 (老司机聚合支付)
$paymentConfig = [
    'enabled' => true,                                      // 是否启用支付功能
    'gateway_url' => 'https://pay.yanshanlaosiji.top',      // 支付网关地址
    'pid' => 1000,                                          // 商户ID (请替换为您的商户ID)
    'key' => 'your-merchant-key',                           // 商户MD5密钥 (请替换为您的密钥)
    'notify_url' => '',                                     // 异步通知地址 (留空则自动生成)
    'return_url' => '',                                     // 同步跳转地址 (留空则自动生成)
    'default_pay_type' => '',                               // 默认支付方式 (空则跳转收银台)

    // 支付渠道开关配置
    // 设置为 true 启用，false 禁用
    'channels' => [
        'cashier' => [
            'enabled' => true,                              // 收银台（默认/自动选择）
            'name' => '收银台',                              // 显示名称
            'icon' => 'fas fa-cash-register',               // 图标类名
            'value' => '',                                  // 传递给支付网关的值（空表示收银台）
            'sort' => 0,                                    // 排序权重（越小越靠前）
        ],
        'alipay' => [
            'enabled' => true,                              // 支付宝
            'name' => '支付宝',
            'icon' => 'fab fa-alipay',
            'icon_color' => '#1677ff',                      // 图标颜色
            'value' => 'alipay',
            'sort' => 1,
        ],
        'wxpay' => [
            'enabled' => true,                              // 微信支付
            'name' => '微信支付',
            'icon' => 'fab fa-weixin',
            'icon_color' => '#07c160',
            'value' => 'wxpay',
            'sort' => 2,
        ],
        'qqpay' => [
            'enabled' => false,                             // QQ支付（默认禁用）
            'name' => 'QQ支付',
            'icon' => 'fab fa-qq',
            'icon_color' => '#12b7f5',
            'value' => 'qqpay',
            'sort' => 3,
        ],
    ],
];

// 计费配置
$billingConfig = [
    'price_per_task' => 0.20,                               // 每次任务价格 (RMB)
    // 兼容旧配置: 若未设置 price_per_task，系统会读取 price_per_image
    'min_recharge' => 1.00,                                 // 最低充值金额 (RMB)
    'max_recharge' => 1000.00,                              // 最高充值金额 (RMB)
    'recharge_options' => [5, 10, 20, 50, 100],             // 快捷充值选项 (RMB)
    'free_quota' => 0,                                      // 新用户免费额度 (次)
    'order_expire_minutes' => 5,                            // 订单过期时间 (分钟)，0表示不过期
];

// 用户系统配置
$userConfig = [
    'enable_registration' => true,                          // 是否开放注册
    'enable_email_verification' => false,                   // 是否需要邮箱验证 (暂不实现)
    'session_lifetime' => 7 * 24 * 3600,                    // 会话有效期 (秒，默认7天)
    'remember_me_lifetime' => 30 * 24 * 3600,               // "记住我"有效期 (秒，默认30天)
    'password_min_length' => 6,                             // 密码最小长度
    'username_min_length' => 3,                             // 用户名最小长度
    'username_max_length' => 20,                            // 用户名最大长度
    'max_login_attempts' => 5,                              // 最大登录尝试次数
    'lockout_duration' => 15 * 60,                          // 锁定时长 (秒)

    // 调试快速登录配置 (仅用于开发环境，生产环境务必关闭)
    // 使用管理员密钥哈希 (admin.key_hash) 作为签名密钥
    'debug_quick_login' => [
        'enabled' => false,                                 // 是否启用调试快速登录 (生产环境必须为 false)
        'ip_whitelist' => ['127.0.0.1', '::1'],             // IP 白名单 (空数组表示不限制IP)
        'expires_seconds' => 300,                           // 快速登录链接有效期 (秒，默认5分钟)
        // 固定测试用户信息
        'test_user' => [
            'username' => 'test_debug_user',                // 测试用户名
            'email' => 'test_debug@example.com',            // 测试邮箱
            'initial_balance' => 100.00,                    // 初始余额 (RMB)
        ],
    ],
];

// 验证码配置
$captchaConfig = [
    'enable_login' => true,                                 // 是否在登录时启用验证码（建议开启以提高安全性）
    'enable_register' => true,                              // 是否在注册时启用验证码
    'width' => 120,                                         // 验证码图片宽度
    'height' => 40,                                         // 验证码图片高度
    'font_size' => 18,                                      // 字体大小
    'chars' => '23456789ABCDEFGHJKLMNPQRSTUVWXYZ',         // 验证码字符集 (排除易混淆字符)
    'expire_time' => 300,                                   // 验证码过期时间 (秒，默认5分钟)
    'noise_lines' => 3,                                     // 干扰线数量
    'noise_dots' => 50,                                     // 干扰点数量
];

// 管理员配置
$adminConfig = [
    'enabled' => true,                                      // 是否启用管理员功能
    'key_hash' => '',                                       // 管理员密钥的SHA-256哈希值 (使用 hash('sha256', '你的密钥') 生成)
    'session_lifetime' => 3600,                             // 会话有效期 (秒，默认1小时)
    'max_attempts' => 5,                                    // 最大登录尝试次数
    'lockout_duration' => 900,                              // 锁定时长 (秒，默认15分钟)

    // 调试快速登录配置 (仅用于开发环境，生产环境务必关闭)
    // 使用管理员密钥哈希值 (key_hash) 作为签名密钥，无需额外配置令牌
    'debug_quick_login' => [
        'enabled' => false,                                 // 是否启用调试快速登录 (生产环境必须为 false)
        'ip_whitelist' => ['127.0.0.1', '::1'],            // IP 白名单 (空数组表示不限制IP)
        'expires_seconds' => 300,                           // 快速登录链接有效期 (秒，默认5分钟)
    ],
];

// 管理员初始化引导配置
$adminSetupConfig = [
    'enabled' => false,                                     // 是否启用初始化引导页
    'require_admin_key' => true,                            // 是否要求管理员密钥
    'ip_whitelist' => ['127.0.0.1', '::1'],                // IP 白名单 (空数组表示不限制IP)
    'csrf_ttl' => 600,                                      // CSRF 令牌有效期 (秒)
];

// 提示: 生成管理员密钥哈希值的方法
// 1. 访问 http://127.0.0.1:8080/generate_admin_key.php 生成哈希值
// 2. 将生成的哈希值填入上方 'key_hash' 配置项
// 3. 使用原始密钥(不是哈希值)登录管理后台

// ============================================================
// 图片模型配置
// ============================================================

$imageModels = [
    // Nano Banana Pro（原默认模型）：支持 1K / 2K / 4K 与搜索接地等能力
    'pro' => [
        'model_name' => 'gemini-3-pro-image-preview',
        'display_name' => 'Nano Banana Pro',
        'supported_image_sizes' => ['1K', '2K', '4K'],
        'supports_google_search' => true,
    ],

    // Nano Banana（快速模型）：官方文档说明为 1024px（约 1K）输出
    'flash' => [
        'model_name' => 'gemini-2.5-flash-image',
        'display_name' => 'Nano Banana',
        'supported_image_sizes' => ['1K'],
        'supports_google_search' => false,
    ],
];

// 开发者快捷切换：默认 'pro' ，将此值改为 'flash' 可切换到快速模型
$activeImageModelKey = 'pro';
$activeImageModel = $imageModels[$activeImageModelKey] ?? $imageModels['pro'];

// ============================================================
// API 与模型配置
// ============================================================

return [
    // API 提供商选择:
    //   'native' - Gemini 原生 API (直连 Google)
    //   'openai_compatible' - OpenAI 兼容中转站
    //   'gemini_proxy' - Gemini 原生格式代理 (SSE 流式响应)
    'api_provider' => 'native',

    // Gemini 原生 API 配置
    'api_key' => 'your-gemini-api-key',

    // OpenAI 兼容中转站配置 (当 api_provider 为 'openai_compatible' 时使用) ，类似 cliproxyapi 中转站
    'openai_compatible' => [
        'base_url' => 'https://your-openai-compatible-endpoint.com',
        'api_key' => 'your-openai-compatible-key',
        'timeout' => 300,
        'connect_timeout' => 30,
        'enable_thinking' => true,  // 启用思考模型，提取 reasoning_content
    ],

    // Gemini 原生格式代理配置 (当 api_provider 为 'gemini_proxy' 时使用) 适用于国内代理站点，NewAPI 类中转站
    // 支持 SSE 流式响应
    'gemini_proxy' => [
        'base_url' => 'https://your-gemini-proxy-endpoint.com',
        'api_key' => 'your-gemini-proxy-key',
        'timeout' => 300,
        'connect_timeout' => 30,
        'use_streaming' => true,    // 使用 SSE 流式接口
        'thinking_budget' => 26240, // 思考预算 (tokens)
    ],

    // 图片模型配置（开发者使用）
    'image_models' => $imageModels,
    'active_image_model' => $activeImageModelKey,
    'image_model_display_name' => $activeImageModel['display_name'],
    'image_model_supported_sizes' => $activeImageModel['supported_image_sizes'],
    'image_model_supports_google_search' => $activeImageModel['supports_google_search'],

    // 模型名称
    'model_name' => $activeImageModel['model_name'],

    // 提示词优化配置
    'prompt_optimize_model' => 'gemini-2.5-flash',
    'prompt_instructs' => [
        'basic' => "你是世界级的AI绘画提示词专家，你的任务是将用户输入的简短提示词扩展为更丰富、更详细、更有表现力的AI绘画提示词。请忠实于原意，补充细节、场景、氛围、构图等信息，提升生成效果。只输出最终扩展后的提示词，不输出思考过程或解释。",
        'detail' => "你是世界级的AI绘画提示词专家，你的任务是将用户输入的简短提示词扩展为极其详细、结构化、客观且详尽的AI绘画提示词。请补充主体、场景、细节、光影、风格、构图等信息，提升生成效果。只输出最终扩展后的提示词，不输出思考过程或解释。",
    ],

    // 默认生成配置
    'generation_config' => [
        'responseModalities' => ['TEXT', 'IMAGE'],
        // 注意: responseMimeType 只支持 text/plain, application/json 等文本格式
        // 图片输出格式由 responseModalities 控制，不需要设置 responseMimeType
        'imageConfig' => [
            'aspectRatio' => '1:1', // 默认 1:1
            'imageSize' => '1K',    // 默认 1K
        ]
    ],

    // 图片生成提示词前缀 (用于强制 AI 理解这是图片生成请求，而非问答)
    // 注意：此前缀仅应用于文生图模式，编辑模式不使用前缀以避免语义冲突
    'image_generation_prefix' => '请生成图片：',

    // 思维摘要配置
    'thinking_config' => [
        'include_thoughts' => true,
        'thinking_level' => 'HIGH',
    ],

    // 图片保存路径 (相对于项目根目录)
    'upload_dir' => 'uploads/',
    'output_dir' => 'images/',
    
    // 系统限制配置
    'limits' => [
        'memory_limit' => '768M',      // 内存限制
        'max_execution_time' => 60,   // 最大执行时间 (秒)
    ],

    // 调试模式 (生产环境务必设为 false)
    'debug' => false,

    // 语音转文字配置
    'speech_to_text' => [
        // 服务提供商配置 (按优先级排序，当启用回退机制时会依次尝试)
        // 目前支持: 'gemini'
        // 未来计划支持: 'whisper', 'azure', 'google_cloud'
        'providers' => ['gemini'],

        // 是否启用回退机制 (当主提供商失败时尝试下一个)
        'enable_fallback' => false,

        // Gemini 提供商配置
        'model' => 'gemini-2.5-flash',  // 使用快速模型进行转录
        'temperature' => 0.1,           // 低温度确保准确转录
        'max_output_tokens' => 2048,
        'timeout' => 60,                // 请求超时时间 (秒)
        'connect_timeout' => 15,        // 连接超时时间 (秒)

        // 音频文件限制
        'max_audio_size' => 10 * 1024 * 1024,  // 最大音频大小 10MB
        'allowed_mime_types' => [
            'audio/webm',
            'audio/mp4',
            'audio/ogg',
            'audio/wav',
            'audio/mpeg',
            'audio/mp3',
        ],

        // 转录提示词 (可自定义以适应不同场景)
        'prompt' => '请将以下音频内容准确转录为文字。只输出转录的文字内容，不要添加任何解释或格式化。如果音频中没有可识别的语音，请返回空字符串。',
    ],

    // ============================================================
    // 用户系统与支付配置 (引用上方定义的变量)
    // ============================================================
    'database' => $databaseConfig,
    'payment' => $paymentConfig,
    'billing' => $billingConfig,
    'user' => $userConfig,
    'captcha' => $captchaConfig,
    'admin' => $adminConfig,
    'admin_setup' => $adminSetupConfig,
];
